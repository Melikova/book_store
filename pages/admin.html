<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Store / Admin</title>
    <link rel="stylesheet" href="../css/font.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
  <div id="admin_login" class="align-items-center justify-content-center" style="display:flex;">
    <form action="" name="admin_login_form">
        <div style="width:662px; height:544px; background-color: #fff; padding:69px 55px 35px 55px">
          <div class="text-center" style="font-size: 44px; font-family: Montserrat; font-weight: 700;">Welcome Admin</div>
          <div class="input-group mb-4 d-flex flex-column mt-4">
            <input name="user_name" id="user_fullname" type="text" class="form-control w-100" placeholder="User Name" aria-label="Username" aria-describedby="basic-addon1" style="height:75px">
          </div>
          <div class="input-group d-flex flex-column">
            <input name="user_password" id="user_password" class="form-control w-100" placeholder="Password" type="password" aria-label="Email" aria-describedby="basic-addon2" style="height:75px">
          </div>
          <button id="loginBtn" type="button" class="btn w-100" style="margin-top:85px; background: #E16A00; height: 75px; font-size:19px; font-family: Crimson Text; font-weight: 700; color:white">Join</button>
        </div>
    </form>
  </div>
  <div id="admin" style="display:none">
    <!-- <div id="myNav" class="overlay">
        <div class="redZone">
            <img id="adminResponsiveLogo" src="../assets/images/responsiveAdminLogo.svg">
            <img src="../assets/icons/closeIcon.svg" style="cursor: pointer;" class="closebtn" onclick="closeNav()">
            <div class="overlay-content">
                <div>
                    <img src="../assets/icons/bookLogo.svg" alt="">
                    <a href="#">Home</a>
                </div>
                <div>
                    <img src="../assets/icons/bookLogo.svg" alt="">
                    <a href="#">About</a>
                </div>
                <div>
                    <img src="../assets/icons/bookLogo.svg" alt="">
                    <a href="#">Join Us</a>
                </div>
                <div>
                    <img src="../assets/icons/bookLogo.svg" alt="">
                    <a href="#">Contact</a>
                </div>
                <div>
                    <img src="../assets/icons/bookLogo.svg" alt="">
                    <a href="#">Logout</a>
                </div>
      
            </div>
        </div>
      </div>
      <header>
        <img src="../assets/images/logo.svg">
        <img src="../assets/icons/hamburgerbar.svg" style="cursor: pointer;" onclick="openNav()">
      </header> -->
    <nav>
        <div>
        <div id="logo" class="">
            <div><img src="../assets/icons/Vector.svg" alt=""></div>
            <div style="width:208px">
                <div id="logo_text">LIBRARY</div>
                <hr>
                <div id="logo_sub_text">Admin Panel</div>
            </div>
        </div> 
        <ul>
            <li>
                <img src="../assets/icons/Vector.svg" alt="">
                <a href="#">Home</a>
            </li>
            <li>
                <img src="../assets/icons/Vector.svg" alt="">
                <a href="#about">About</a>
            </li>
            <li>
                <img src="../assets/icons/Vector.svg" alt="">
                <a href="#join">Join Us</a>
            </li>
            <li>
                <img src="../assets/icons/Vector.svg" alt="">
                <a href="#contact">Contact</a>
            </li>
            <li>
                <img src="../assets/icons/Vector.svg" alt="">
                <a id="log_out" href="#">Logout</a>
            </li>
        </ul>
    </div>
    </nav>
    <div id="main">
        <div class="container-fluid">
            <div class="row" id="user">
                <div class="col text-end"><img src="../assets/icons/user.png" alt="">Admin</div>
            </div>
            <div class="row" id="home">
                <div class="col d-flex flex-column">
                    <p>Add book</p>
                    <p class="h4 py-3">Search Book</p>
                    <input type="text" class="h-25 w-50" id="search">
                    <div class="text-center w-50">
                        <div id="searchBookResult" style="background-color: #f7f4ee; overflow: scroll;" class="border rounded h-50">
                            <!-- <div class="w-25 d-flex h6 align-items-center" style="cursor: pointer;"><img class="w-100 p-2" src="../assets/images/book_1.png" alt=""><p>Robinson</p></div> -->
                        </div>
                    </div>
                </div>
                
                <p class="h4 py-3 mt-5">Book Form</p>
                <form class="bg-white shadow px-3 py-4 rounded">
                    <div class="mb-3">
                      <label for="book_title" class="form-label">Book Name</label>
                      <input id="bookName" type="text" class="form-control shadow" id="book_title">
                    </div>
                    <div class="mb-3">
                      <label for="book_author_name" class="form-label">Author Name</label>
                      <input id="authorName" type="text" class="form-control shadow" id="book_author_name">
                    </div>
                    <div class="mb-3">
                        <label for="book_image_url" class="form-label">Book image URL</label>
                        <input id="bookImg" type="text" class="form-control shadow" id="book_image_url">
                    </div>
                    <div class="mb-3">
                        <label for="book_desc" class="form-label">Description</label>
                        <input id="description"  type="text" class="form-control shadow" id="book_desc">
                    </div>
                    <div class="mb-3 d-flex flex-column">
                        <label for="book_type" class="form-label">Book Type</label>
                        <select id="select" style="height: 40px;" class="rounded">
                          <option selected>Fantastic</option>
                        </select>
                        <input id="bookType" type="text" class="form-control shadow" id="book_type">
                    </div>
                    <button type="button" class="btn w-100" id="addBookButton" style="background-color: #FF8B00;">Add</button>
                  </form>
            </div>
            <div class="row mt-5" id="about">
                <div class="col">About Store</div>
                <form class="bg-white shadow px-3 py-4 rounded">
                    <div class="mb-3">
                      <label for="about_title" class="form-label">Title</label>
                      <input type="text" class="form-control" id="about_title">
                    </div>
                    <div class="mb-3">
                      <label for="about_image_url" class="form-label">Book Image URL</label>
                      <input type="text" class="form-control" id="about_image_url">
                    </div>
                    <div class="mb-3">
                        <label for="about_desc" class="form-label">Description</label>
                        <textarea type="text" class="form-control" id="about_desc"></textarea>
                      </div>
                    <button type="button" class="btn w-100" id="about_submit_button">About Info Add</button>
                  </form>
            </div>
            <div class="row" id="join">
                <div class="col">Join Us</div>
                <table id="join_table"></table>
            </div>
            <div class="row" id="contact">
                <div class="col">Contact Us</div>
                <table id="contacts_table"></table>
            </div>
        </div>
    </div>
  </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <script src="../js/responsive.js"></script>
    <script src="../js/db_config.js"></script>
    <script type="module">

      function checkLogin(){
        if (localStorage.getItem('admin')=='false') {
          $('#admin_login').attr("style", "display:flex");
          $('#admin').attr("style", "display:none");
        }else{
          $('#admin_login').attr("style", "display:none");
          $('#admin').attr("style", "display:block");
        }
      }

      checkLogin();

      console.log(localStorage.getItem('admin'));

      $('#loginBtn').on('click', function(e){
          e.preventDefault();
          localStorage.setItem('admin', true);
          checkLogin();
      })

      $('#log_out').on('click', function(){
        localStorage.setItem('admin', 'false');
        console.log(localStorage.getItem('admin'));
        checkLogin();
      })

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref, set, get, push, onValue, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
        const app = initializeApp(firebaseConfig);

        
const apiKey = "AIzaSyAkvx-sx9SeDZe-FkrmgSgY35x6zuMSEQw";
const searchInput = document.querySelector("#search");
const searchBookResult = document.querySelector("#searchBookResult");
const bookName = document.querySelector("#bookName");
const authorName = document.querySelector("#authorName");
const bookImg = document.querySelector("#bookImg");
const description = document.querySelector("#description");
const bookType = document.querySelector("#bookType");
const addBookButton = document.querySelector("#addBookButton") 
const categoryInput = document.querySelector("#categoryInput")
const select = document.querySelector("#select")
const addDiv = document.querySelector("#addDiv")
const openAddDiv = document.querySelector("#openAddDiv")

let timer;

// Debounce function
async function getApi(query) {
  clearTimeout(timer);

  timer = setTimeout(async () => {
    try {
      const apiUrl = `https://www.googleapis.com/books/v1/volumes?q=${query}&maxResults=5&key=${apiKey}`;
      const response = await fetch(apiUrl);
      const data = await response.json();
      console.log("data: ", data.items);
      printResult(data);
    } catch (err) {
      console.log("err: ", err);
    }
  }, 300);
    
}

// Checks the entered character
function changeEvent(event) {
  const query = event.target.value.trim().toLowerCase();
  const lastChar = query.charAt(query.length - 1);

    if (lastChar.match(/[a-z]/i)) {
    getApi(query);
  } else {
    clearResult();
  }
}

function searcInput(event) {
  if (event.keyCode === 13) {
    let text = searchInput.value;
    console.log(text);
    getApi(text);
  }
}

function clearResult() {
  searchBookResult.innerHTML = "";
  
}



function printResult(data) {
  clearResult();

  data.items.forEach((bookItem) => {
    const smallThumbnailLink = bookItem.volumeInfo.imageLinks.smallThumbnail;
    const bookTitle = bookItem.volumeInfo.title;
    const bookAuthorName = bookItem.volumeInfo.authors;
    const bookDescription = bookItem.volumeInfo.description;
    const searchBookType = bookItem.volumeInfo.categories;


    const bookElement = document.createElement("div");
    bookElement.classList.add("w-25", "d-flex", "h6", "align-items-center");
    bookElement.style.cursor = "pointer";
    bookElement.innerHTML = `
      <img class="w-100 p-2" src="${smallThumbnailLink}" alt="">
      <p>${bookTitle}</p>`;

    bookElement.addEventListener("click", () => {
      
      bookName.value = bookTitle
      authorName.value = bookAuthorName
      bookImg.value = smallThumbnailLink
      description.value = bookDescription
      bookType.value = searchBookType
      searchInput.value = ""
      clearResult()

    })

    searchBookResult.appendChild(bookElement);
  });
}


// when user click out input
// document.addEventListener("mousedown", (event) => {
//   const clickInput = searchInput.contains(event.target);
//   if (!clickInput) {
//     searchInput.value = "";
//     clearResult();
//   }
// });

searchInput.addEventListener("input", changeEvent);
searchInput.addEventListener("keyup", searcInput);


        getUsersData();
        getContactsData();
        getAboutData();

        $('#about_submit_button').click(()=>{
            postAboutData($('#about_title').val(), $('#about_image_url').val(), $("#about_desc").val());
            getAboutData();
        });

        
        $('#join_table').on('click', 'a', function (e){
            e.preventDefault();
            deleteDataFromTable('users', $(this).data('id'));
            $('#join_table').html(' ');
            getUsersData();
        });

        $('#contacts_table').on('click', 'a', function (e){
            e.preventDefault();
            deleteDataFromTable('contacts', $(this).data('id'));
            $('#contacts_table').html(' ');
            getContactsData();
        });

        function getAboutData(){
          const db = getDatabase();
            return onValue(ref(db, '/about'), (snapshot) => {
              const data = snapshot.val() || false;
              $('#about_title').val(data.about_title);
              $('#about_image_url').val(data.image_url);
              $("#about_desc").val(data.description);
            }, {
              onlyOnce: true
            });
        }

        function getUsersData() {
            const db = getDatabase();
            return onValue(ref(db, '/users'), (snapshot) => {
              const users = snapshot.val() || false;
              createJoinTable('#join_table', ['#', 'Full Name', 'Email Address', 'Delete'], users);
            }, {
              onlyOnce: true
            });
        }

        function getContactsData() {
            const db = getDatabase();
            return onValue(ref(db, '/contacts'), (snapshot) => {
              const contacts = snapshot.val() || false;
              createContactsTable('#contacts_table', ['#', 'Full Name', 'Address', 'Email Address', 'Phone Number', 'Note', 'Delete'], contacts);
            }, {
              onlyOnce: true
            });
        }

        function createJoinTable(table_id, col_names_arr, data){
            let thead=``; let tbody='';
            col_names_arr.forEach(element=>{
                thead += `<th scope="col">${element}</th>`;
            });
            thead=`<thead><tr>${thead}</tr></thead>`;
            if(data){                                
                Object.entries(data).forEach((element, key) => {
                tbody += `<tr>
                            <th scope="row">${key+1}</th>
                            <td>${element[1].username}</td>
                            <td>${element[1].email}</td>
                            <td><a href="#" data-id="${element[0]}"><img width="16px" src="../assets/icons/trash-can-regular.svg" alt=""></a></td>
                        </tr>`;
            });
            }else{
                tbody=`<tr><th scope="row">1</th><td colspan="${col_names_arr.length}">No Data</td></tr>`;
            }
            tbody = `<tbody>${tbody}</tbody>`;
            $(table_id).append(thead);
            $(table_id).append(tbody);
        }

        function createContactsTable(table_id, col_names_arr, data){
            let thead=``; let tbody='';
            col_names_arr.forEach(element=>{
                thead += `<th scope="col">${element}</th>`;
            });
            thead=`<thead><tr>${thead}</tr></thead>`;
            if(data){                                
                Object.entries(data).forEach((element, key) => {
                tbody += `<tr>
                            <th scope="row">${key+1}</th>
                            <td>${element[1].name}</td>
                            <td>${element[1].address}</td>
                            <td>${element[1].email}</td>
                            <td>${element[1].phone}</td>
                            <td>${element[1].note}</td>
                            <td><a href="#" data-id="${element[0]}"><img width="16px" src="../assets/icons/trash-can-regular.svg" alt=""></a></td>
                        </tr>`;
            });
            }else{
                tbody=`<tr><th scope="row">1</th><td colspan="${col_names_arr.length}">No Data</td></tr>`;
            }
            tbody = `<tbody>${tbody}</tbody>`;
            $(table_id).append(thead);
            $(table_id).append(tbody);
        }

        function postAboutData(title, url, desc) {
            const db = getDatabase();
            set(ref(db, 'about'), {about_title: title, image_url: url, description: desc});
        }

        function deleteDataFromTable(table, id){
            const db = getDatabase();
            return remove(ref(db, `/${table}/${id}`)).then(() => {
              console.log("location removed");
            }); 
        }

        function getAddBookAdmin(){
            const db = getDatabase();
            if(!bookName.value){
              alert("write book name")
              return
            }

            set(ref(db, "addApiBooks/" + bookName.value), {
                name: bookName.value,
                authorName : authorName.value,
                imageUrl: bookImg.value,
                description : description.value,
                bookType: bookType.value
            }).then(()=>{
                alert('Successfully Added');
            }).catch(()=>{
                alert('Error Adding Book')
            })

        }

        function addBookFairbase(){
            const db = getDatabase();
            // select.innerHTML += `<option>${categoryInput.value}</option>`
            push(ref(db, "categories/"), {
              bookCategories: bookType.value,
            })
            .then(()=>{
              alert('Successfully added category to fairbase!')
            }).catch((error)=>{
              alert(error)
            })
        }

        function getFairbaseCategory(){
          const db = getDatabase()
          get(ref(db, "/categories"))
          .then((snapshot)=>{
            if(snapshot.val()){
              let fairCategory = snapshot.val()
              let dataArray = Object.entries(fairCategory)

              dataArray.forEach((el)=>{

                select.innerHTML += `<option>${el[1].bookCategories}</option>`
              })
              console.log(dataArray);
            }
          })
        }


        document.addEventListener("DOMContentLoaded", getFairbaseCategory)
        addBookButton.addEventListener("click", getAddBookAdmin)
        addBookButton.addEventListener("click", addBookFairbase)
      
      
      </script>
</body>
</html>